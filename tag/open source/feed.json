{
    "version": "https://jsonfeed.org/version/1",
    "title": "The Workshop",
    "subtitle": "",
    "icon": "https://the-m3chanic.github.io/images/favicon.ico",
    "description": "",
    "home_page_url": "https://the-m3chanic.github.io",
    "items": [
        {
            "id": "https://the-m3chanic.github.io/2024/06/07/GSoC-with-RTEMS-Week-1/",
            "url": "https://the-m3chanic.github.io/2024/06/07/GSoC-with-RTEMS-Week-1/",
            "title": "GSoC with RTEMS! - 1/n",
            "date_published": "2024-06-06T22:00:07.000Z",
            "content_html": "<p>Extending the features of a debugger, especially GDB, sounded like a fun and interesting project at first glance. I already have quite a bit of experience working with GDB, and use it almost daily while Reverse Engineering or during CTFs. GDB has an awesome Python API that it utilizes to do things it cannot do straight out the box, and one such thing is pretty-printing.</p>\n<p>Imagine you have a weird class/structure in your program, and you want to view it in memory, so you pop it open in GDB. Then you print your variable in GDB and it spits out something so awful that you wish you never started debugging in the first place. This is because GDB obviously cannot know about any and every single structure out there, and sometime it needs a little help - this is where the awesome Python API I mentioned comes in.</p>\n<p>Python essentially hooks onto GDB and interprets something GDB might be unable to, then do some Python magic and voila, you have the same structure neatly formatted! Some nice examples and a deeper explanation of what pretty-printing can be found in the <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2V3YXJlLm9yZy9nZGIvY3VycmVudC9vbmxpbmVkb2NzL2dkYi5odG1sL1ByZXR0eS1QcmludGluZy5odG1sI1ByZXR0eS1QcmludGluZw==\">documentation</span></p>\n<p>GCC ships pretty-printing scripts for  <code>libstdcxx</code> , which is essentially all of the C++ STL Structures, and my job is to get the GDB installed on <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnRlbXMub3Jn\">RTEMS</span> to automatically load these pretty-printing scripts at load-time, to enhance the debugging experience on RTEMS ðŸ˜ƒ. Next, add pretty-printing support for kernel structures present on RTEMS.</p>\n<p>Starting off, I already had a couple of things to get ticked off my checklist. I wanted to mainly set up a proper debugging environment, and also study various commonly used kernel structures - before diving deeper into my project. Since my project itself was to extend the functionality of the debugger, what good is it if I don't have a debugging environment setup in place?</p>\n<p>Let's jump right into my debugger setup then.</p>\n<p>I am working on a Windows 11 (x64), WSL2 (Arch) system. On top of this, I have the RTEMS tooling installed from the instructions in their <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnJ0ZW1zLm9yZy9icmFuY2hlcy9tYXN0ZXIvdXNlci9zdGFydC9zb3VyY2VzLmh0bWw=\">documentation</span>. On top of that, they provide a variety of options to build various BSPs (think of BSPs as housing for the OS to be embedded upon). I needed a build setup such that:</p>\n<ul>\n<li>I could compile RTEMS C++ programs at will</li>\n<li>GDB could debug those programs remotely through a remote emulator (either built in, or using <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucWVtdS5vcmc=\">Qemu</span>)</li>\n</ul>\n<p>First, to build a BSP. I had to make 2 important choices:</p>\n<ul>\n<li>Which architecture will I use?</li>\n<li>Which BSP will I use for said architecture? (Note: A single architecture can support multiple BSPs)</li>\n</ul>\n<p>I initially thought  <code>x86_64</code>  arch, along with any suitable BSP for that arch would have me good to go, but I was sadly mistaken. Not only did I struggle to find BSPs for  <code>x86_64</code> , but I also found that there were no test configurations (yet) for any of the  <code>x86_64</code>  BSPs ðŸ˜¦, so I decided not to proceed with that</p>\n<p>Next up, I chose the  <code>sparc</code>  arch, along with the  <code>erc32</code>  BSP, since that was one which seemed to have very good support for emulation and GDB support, and was also the one used in most of the examples mentioned in the docs. So I went ahead and built that.</p>\n<p><code>sparc</code>  has an emulator built in in RTEMS,  <code>sparc-rtems6-sis</code>  ( <code>sis</code> : Sparc Instruction Set Simulator), which can emulate the instructions of the RTEMS executable, and GDB can attach to the process through a TCP port.</p>\n<p>However, although compiling RTEMS C++ programs and running them worked perfectly on my  <code>sparc/erc32</code>  build, I couldn't debug (i.e, step through) code conveniently. I kept hitting some kind of data access violation exception, due to which RTEMS would have a fatal crash and exit. Sad.</p>\n<p>So I finalised on the  <code>arm/xilinx_zynq_a9_qemu</code>  BSP upon the suggestion of my mentor, which worked perfectly. So, I will be using that for the rest of this blog.</p>\n<p>First, a sample C++ program.<br />\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// main.cc </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;numeric&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;vector&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">auto</span> v = std::<span class=\"built_in\">vector</span>&lt;<span class=\"type\">int</span>&gt;(<span class=\"number\">5</span>);</span><br><span class=\"line\">    std::<span class=\"built_in\">iota</span>(std::<span class=\"built_in\">begin</span>(v), std::<span class=\"built_in\">end</span>(v), <span class=\"number\">0</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">auto</span> i : v) </span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        std::cout &lt;&lt; i &lt;&lt; std::endl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>First off, RTEMS uses  <code>waf</code>  (an alternative to  <code>make</code> ), to build BSPs and applications on the platform. It's pretty versatile and easy to understand. You need 2 main things to build any app like this on RTEMS (apart from the source, of course) -  <code>waf</code>  (the script doing all the work) &amp;  <code>wscript</code>  (the waf script containing instructions to be executed). Apart from these 2 files, you would also need some dependency files, and an initialisation script.</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnJ0ZW1zLm9yZy9icmFuY2hlcy9tYXN0ZXIvdXNlci9zdGFydC9hcHAuaHRtbA==\">This</span> page in the documentation gives a pretty good overview on how one can build an app on RTEMS.</p>\n<p>Here is my  <code>wscript</code>  for all C++ applications like the one above:<br />\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># wscript </span></span><br><span class=\"line\"><span class=\"keyword\">from</span> __future__ <span class=\"keyword\">import</span> print_function</span><br><span class=\"line\"></span><br><span class=\"line\">rtems_version = <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    <span class=\"keyword\">import</span> rtems_waf.rtems <span class=\"keyword\">as</span> rtems</span><br><span class=\"line\"><span class=\"keyword\">except</span>:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;error: no rtems_waf git submodule&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">import</span> sys</span><br><span class=\"line\">    sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">init</span>(<span class=\"params\">ctx</span>):</span><br><span class=\"line\">    rtems.init(ctx, version = rtems_version, long_commands = <span class=\"literal\">True</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">bsp_configure</span>(<span class=\"params\">conf, arch_bsp</span>):</span><br><span class=\"line\">    <span class=\"comment\"># Add BSP specific configuration checks</span></span><br><span class=\"line\">    <span class=\"keyword\">pass</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">options</span>(<span class=\"params\">opt</span>):</span><br><span class=\"line\">    rtems.options(opt)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">configure</span>(<span class=\"params\">conf</span>):</span><br><span class=\"line\">    rtems.configure(conf, bsp_configure = bsp_configure)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">build</span>(<span class=\"params\">bld</span>):</span><br><span class=\"line\">    rtems.build(bld)</span><br><span class=\"line\"></span><br><span class=\"line\">    bld(features = <span class=\"string\">&#x27;cxx cxxprogram&#x27;</span>,</span><br><span class=\"line\">        target = <span class=\"string\">&#x27;cxx_stdmap.exe&#x27;</span>,</span><br><span class=\"line\">        cxxflags = <span class=\"string\">&#x27;-std=c++11 -g -O2 -lstdc++&#x27;</span>,</span><br><span class=\"line\">        source = [<span class=\"string\">&#x27;main.cc&#x27;</span>, <span class=\"string\">&#x27;rtems_config.c&#x27;</span>])</span><br></pre></td></tr></table></figure></p>\n<p>The main function we need to focus on is  <code>build</code> . Note the  <code>features</code>  (type of program), and  <code>cxxflags</code>  parameters passed to the  <code>bld</code>  function.</p>\n<p>The application can be built with:</p>\n<p><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># configure the waf for the BSP you are building for </span><br><span class=\"line\"></span><br><span class=\"line\">./waf configure --prefix=$HOME/quick-start/rtems/6 --rtems-bsps=arm/xilinx_zynq_a9_qemu</span><br></pre></td></tr></table></figure></p>\n<p><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># build the app</span><br><span class=\"line\"></span><br><span class=\"line\">./waf</span><br></pre></td></tr></table></figure></p>\n<p><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># run the executable to ensure it works</span><br><span class=\"line\"></span><br><span class=\"line\">rtems-run --rtems-bsps=xilinx_zynq_a9_qemu build/arm-rtems6-xilinx_zynq_a9_qemu/cxx_vectorfail.exe</span><br></pre></td></tr></table></figure></p>\n<p>Once you confirm that the app works, we can move onto debugging it.<br />\nFirst, for emulation, I went with qemu. I already had a  <code>qemu-system-arm</code>  setup so it seemed like the most logical option.</p>\n<p>Program can be emulated with:<br />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># machine type: xilinx-zynq-a9</span><br><span class=\"line\"># -m 256: 256 megabytes of memory for emulation</span><br><span class=\"line\"># no-reboot: prevents the machine from automatically rebooting after shutdown</span><br><span class=\"line\"># -serial null: serial port output is piped to /dev/null</span><br><span class=\"line\"># -serial mon:stdio : redirects serial monitor output through stdio </span><br><span class=\"line\"># -nographic: disables graphics </span><br><span class=\"line\"># -s: enables GDB to debug </span><br><span class=\"line\"># -S: starts up Qemu in a paused state, allowing GDB time to connect before execution begins </span><br><span class=\"line\"></span><br><span class=\"line\">qemu-system-arm -M xilinx-zynq-a9 -m \\</span><br><span class=\"line\">    256M -no-reboot -serial \\</span><br><span class=\"line\">    null -serial mon:stdio -nographic \\</span><br><span class=\"line\">    -s -S</span><br></pre></td></tr></table></figure></p>\n<p>On a separate terminal, connect to this emulator (default port: 1234)</p>\n<p><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">arm-rtems6-gdb &lt;app_path.exe&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"># inside gdb </span><br><span class=\"line\">(gdb) target extended-remote localhost:1234 </span><br><span class=\"line\">(gdb) load</span><br><span class=\"line\">...</span><br><span class=\"line\"># any gdb command you want</span><br></pre></td></tr></table></figure></p>\n<p>More information on remote debugging can be found <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2V3YXJlLm9yZy9nZGIvY3VycmVudC9vbmxpbmVkb2NzL2dkYi5odG1sL0Nvbm5lY3RpbmcuaHRtbA==\">here</span>.</p>\n<p>Voila! Debugging environment set up!</p>\n<p>Now, this is a pretty big process, with a lot of commands. This can be made easier, of course. Shell scripting for the win.</p>\n<p><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># ./setup.sh </span><br><span class=\"line\"># initialise environment to build the application </span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;[+] Installing waf...&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">curl https://waf.io/waf-2.0.19 &gt; waf</span><br><span class=\"line\">chmod +x waf</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;[+] Initialising repository and adding dependencies...&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">git init</span><br><span class=\"line\">git submodule add git://git.rtems.org/rtems_waf.git rtems_waf</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;[+] Configuring waf...&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">./waf configure --rtems=$HOME/quick-start/rtems/6 --rtems-bsp=arm/xilinx_zynq_a9_qemu</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;[+] Building application...&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">./waf</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;[+] Running application...&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">rtems-run --rtems-bsps=xilinx_zynq_a9_qemu build/arm-rtems6-xilinx_zynq_a9_qemu/cxx_vectorfail.exe</span><br></pre></td></tr></table></figure></p>\n<p>On a different terminal:<br />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">qemu-system-arm -M xilinx-zynq-a9 -m \\</span><br><span class=\"line\">    256M -no-reboot -serial \\</span><br><span class=\"line\">    null -serial mon:stdio -nographic \\</span><br><span class=\"line\">    -s -S</span><br></pre></td></tr></table></figure></p>\n<p>Make a script called  <code>init.gdb</code> <br />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">target extended-remote localhost:1234</span><br><span class=\"line\">load</span><br></pre></td></tr></table></figure></p>\n<p>On the first terminal, create a new shell script<br />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># ./loadgdb.sh</span><br><span class=\"line\">arm-rtems6-gdb -x init.gdb build/arm-rtems6-xilinx_zynq_a9_qemu/cxx_vectorfail.exe</span><br></pre></td></tr></table></figure></p>\n<p>I have all of these configured as commands on my terminal to make life easier, you could do that as well.</p>\n<p>In next week's blog, I will be diving straight into the main crux of my project - the issue at hand, and how I plan on fixing it, stay tuned!</p>\n",
            "tags": [
                "GSoC",
                "Embedded",
                "GDB",
                "Debugging",
                "Open source"
            ]
        }
    ]
}